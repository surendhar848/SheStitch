{"ast":null,"code":"import React,{useState,useEffect,useRef}from\"react\";// Universal ChatPanel component for both seller and customer\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";export default function ChatPanel(_ref){let{userId,otherId,userRoleId,otherRoleId,senderName,receiverName}=_ref;const[chatId,setChatId]=useState(null);const[messages,setMessages]=useState([]);const[input,setInput]=useState(\"\");const chatEndRef=useRef(null);// Ensure chat room exists and fetch its id\nuseEffect(()=>{async function getOrCreateChat(){const res=await fetch(\"http://localhost:8000/api/chat_s\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({sender_id:userId,receiver_id:otherId,sender_role_id:userRoleId,created_by:userId})});if(res.ok){var _chat$id;const chat=await res.json();setChatId((_chat$id=chat===null||chat===void 0?void 0:chat.id)!==null&&_chat$id!==void 0?_chat$id:null);}}if(userId&&otherId&&userRoleId&&otherRoleId)getOrCreateChat();},[userId,otherId,userRoleId,otherRoleId]);// Fetch messages for this chat\nuseEffect(()=>{if(!chatId)return;async function fetchMessages(){const res=await fetch(\"http://localhost:8000/api/chat_message_s/\".concat(chatId));if(res.ok){const msgs=await res.json();setMessages(Array.isArray(msgs)?msgs.filter(Boolean):[]);}}fetchMessages();const interval=setInterval(fetchMessages,5000);return()=>clearInterval(interval);},[chatId]);// Always scroll to bottom on new message\nuseEffect(()=>{var _chatEndRef$current;(_chatEndRef$current=chatEndRef.current)===null||_chatEndRef$current===void 0?void 0:_chatEndRef$current.scrollIntoView({behavior:\"smooth\"});},[messages]);async function sendMessage(){if(!input.trim()||!chatId)return;const newMsg={message:input,sender_id:userId,sender_role_id:userRoleId,receiver_id:otherId,msg_type:\"text\"};const res=await fetch(\"http://localhost:8000/api/chat_message_s/\".concat(chatId),{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify(newMsg)});if(res.ok){const saved=await res.json();setMessages(prev=>[...prev,saved]);setInput(\"\");}}return/*#__PURE__*/_jsxs(\"div\",{className:\"bg-white/90 shadow-xl rounded-xl w-full mt-8 animate__animated animate__fadeIn\",children:[/*#__PURE__*/_jsx(\"div\",{className:\"flex items-center gap-3 p-4 border-b bg-gradient-to-r from-green-200 to-blue-200\",children:/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(\"div\",{className:\"font-bold text-lg text-green-700\",children:receiverName||\"Chat\"})})}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-6 h-96 overflow-y-auto bg-gradient-to-br from-white to-blue-50\",children:[(messages||[]).filter(msg=>msg&&typeof msg===\"object\"&&\"id\"in msg).map((msg,idx)=>/*#__PURE__*/_jsx(\"div\",{className:\"mb-2 flex \".concat(msg.sender_id===userId?\"justify-end\":\"justify-start\"),children:/*#__PURE__*/_jsx(\"div\",{className:\"p-2 rounded-lg max-w-xs \".concat(msg.sender_id===userId?\"bg-green-500 text-white\":\"bg-gray-200\"),children:msg.message})},msg.id||idx)),/*#__PURE__*/_jsx(\"div\",{ref:chatEndRef})]}),/*#__PURE__*/_jsxs(\"div\",{className:\"p-4 border-t bg-white flex gap-2\",children:[/*#__PURE__*/_jsx(\"input\",{className:\"flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-green-300\",placeholder:\"Type your message...\",value:input,onChange:e=>setInput(e.target.value),onKeyDown:e=>e.key===\"Enter\"&&sendMessage()}),/*#__PURE__*/_jsx(\"button\",{className:\"bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition\",onClick:sendMessage,children:\"Send\"})]})]});}","map":{"version":3,"names":["React","useState","useEffect","useRef","jsx","_jsx","jsxs","_jsxs","ChatPanel","_ref","userId","otherId","userRoleId","otherRoleId","senderName","receiverName","chatId","setChatId","messages","setMessages","input","setInput","chatEndRef","getOrCreateChat","res","fetch","method","headers","body","JSON","stringify","sender_id","receiver_id","sender_role_id","created_by","ok","_chat$id","chat","json","id","fetchMessages","concat","msgs","Array","isArray","filter","Boolean","interval","setInterval","clearInterval","_chatEndRef$current","current","scrollIntoView","behavior","sendMessage","trim","newMsg","message","msg_type","saved","prev","className","children","msg","map","idx","ref","placeholder","value","onChange","e","target","onKeyDown","key","onClick"],"sources":["C:/Users/admin/OneDrive/ドキュメント/reactjs/tailoring-app/src/components/ChatPanel.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from \"react\";\r\n\r\n// Universal ChatPanel component for both seller and customer\r\nexport default function ChatPanel({\r\n  userId,\r\n  otherId,\r\n  userRoleId,\r\n  otherRoleId,\r\n  senderName,\r\n  receiverName,\r\n}) {\r\n  const [chatId, setChatId] = useState(null);\r\n  const [messages, setMessages] = useState([]);\r\n  const [input, setInput] = useState(\"\");\r\n  const chatEndRef = useRef(null);\r\n\r\n  // Ensure chat room exists and fetch its id\r\n  useEffect(() => {\r\n    async function getOrCreateChat() {\r\n      const res = await fetch(\"http://localhost:8000/api/chat_s\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          sender_id: userId,\r\n          receiver_id: otherId,\r\n          sender_role_id: userRoleId,\r\n          created_by: userId,\r\n        }),\r\n      });\r\n      if (res.ok) {\r\n        const chat = await res.json();\r\n        setChatId(chat?.id ?? null);\r\n      }\r\n    }\r\n    if (userId && otherId && userRoleId && otherRoleId) getOrCreateChat();\r\n  }, [userId, otherId, userRoleId, otherRoleId]);\r\n\r\n  // Fetch messages for this chat\r\n  useEffect(() => {\r\n    if (!chatId) return;\r\n    async function fetchMessages() {\r\n      const res = await fetch(`http://localhost:8000/api/chat_message_s/${chatId}`);\r\n      if (res.ok) {\r\n        const msgs = await res.json();\r\n        setMessages(Array.isArray(msgs) ? msgs.filter(Boolean) : []);\r\n      }\r\n    }\r\n    fetchMessages();\r\n    const interval = setInterval(fetchMessages, 5000);\r\n    return () => clearInterval(interval);\r\n  }, [chatId]);\r\n\r\n  // Always scroll to bottom on new message\r\n  useEffect(() => {\r\n    chatEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [messages]);\r\n\r\n  async function sendMessage() {\r\n    if (!input.trim() || !chatId) return;\r\n    const newMsg = {\r\n      message: input,\r\n      sender_id: userId,\r\n      sender_role_id: userRoleId,\r\n      receiver_id: otherId,\r\n      msg_type: \"text\",\r\n    };\r\n    const res = await fetch(`http://localhost:8000/api/chat_message_s/${chatId}`, {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"application/json\" },\r\n      body: JSON.stringify(newMsg),\r\n    });\r\n    if (res.ok) {\r\n      const saved = await res.json();\r\n      setMessages((prev) => [...prev, saved]);\r\n      setInput(\"\");\r\n    }\r\n  }\r\n\r\n  return (\r\n    <div className=\"bg-white/90 shadow-xl rounded-xl w-full mt-8 animate__animated animate__fadeIn\">\r\n      <div className=\"flex items-center gap-3 p-4 border-b bg-gradient-to-r from-green-200 to-blue-200\">\r\n        <div>\r\n          <div className=\"font-bold text-lg text-green-700\">{receiverName || \"Chat\"}</div>\r\n        </div>\r\n      </div>\r\n      <div className=\"p-6 h-96 overflow-y-auto bg-gradient-to-br from-white to-blue-50\">\r\n        {(messages || [])\r\n          .filter((msg) => msg && typeof msg === \"object\" && \"id\" in msg)\r\n          .map((msg, idx) => (\r\n            <div\r\n              key={msg.id || idx}\r\n              className={`mb-2 flex ${msg.sender_id === userId ? \"justify-end\" : \"justify-start\"}`}\r\n            >\r\n              <div\r\n                className={`p-2 rounded-lg max-w-xs ${\r\n                  msg.sender_id === userId ? \"bg-green-500 text-white\" : \"bg-gray-200\"\r\n                }`}\r\n              >\r\n                {msg.message}\r\n              </div>\r\n            </div>\r\n          ))}\r\n        <div ref={chatEndRef} />\r\n      </div>\r\n      <div className=\"p-4 border-t bg-white flex gap-2\">\r\n        <input\r\n          className=\"flex-1 border rounded px-3 py-2 focus:ring-2 focus:ring-green-300\"\r\n          placeholder=\"Type your message...\"\r\n          value={input}\r\n          onChange={(e) => setInput(e.target.value)}\r\n          onKeyDown={(e) => e.key === \"Enter\" && sendMessage()}\r\n        />\r\n        <button\r\n          className=\"bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition\"\r\n          onClick={sendMessage}\r\n        >\r\n          Send\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}